;(function($,_,undefined){"use strict";ips.controller.register('core.front.plugins.nbITunesBBCode',{_timer:null,_ajax:null,_params:null,_term:'',_disabled:[],initialize:function(){this.on('click','[data-action="selectItem"]',this.selectItem);this.on('click','[data-action="customInfo"]',this.customInfo);this.on('paginationClicked paginationJump',this.paginationClicked);this.on('focus','[data-role="nbITunesSearch"]',this.focusITunesSearch);this.on('blur','[data-role="nbITunesSearch"]',this.blurITunesSearch);this.on('change','[data-role^="nbITunesFilters_"] select',this.setParams);var self=this;$(document).on('submitDialog',function(e,data){if(!$.isEmptyObject(data.response)&&!_.isUndefined(data.response['nbITunesBBCode'])&&data.response['nbITunesBBCode']==1&&!_.isUndefined(data.response['nbITunesCustomInfo'])){var elem=$('[data-nbitunesitemid="'+data.response['nbITunesItemId']+'"]');self.selectItem(e,elem,data.response['nbITunesCustomInfo']);}});},customInfo:function(e){e.preventDefault();e.stopPropagation();var scope=this.scope;var nbITunesJson=$(e.currentTarget).parents('.nbITunesItem').attr('data-nbITunesJson');var dialogRef=ips.ui.dialog.create({fixed:false,size:'medium',title:ips.getString('nbitunes_custom_info'),url:'?app=core&module=system&controller=plugins&do=nbITunesCustomInfo&editorId='+scope.attr('data-editorId'),forceReload:true,destructOnClose:true,remoteSubmit:true,callback:function(){$('[name="nbitunes_custom_info_field"]').focus();},ajax:{type:'post',data:{'data':nbITunesJson},}});dialogRef.show();},selectItem:function(e,elem,customInfo){e.preventDefault();var nbITunesJson,templateRender,nbITunesTemplate;var scope=this.scope;var target=elem?elem:$(e.currentTarget);try{nbITunesJson=$.parseJSON(target.attr('data-nbITunesJson'));if(customInfo){nbITunesJson=[];nbITunesJson['nbITunesCustomInfo']=customInfo;}
nbITunesTemplate=target.attr('data-nbITunesTemplate');templateRender=ips.templates.render('templates.plugins.nbITunesBBCodeItem.'+nbITunesTemplate,nbITunesJson);}catch(err){}
if(templateRender){try{if(!_.isUndefined(CKEDITOR)&&CKEDITOR!=null){var editor=CKEDITOR.instances[scope.attr('data-editorId')];var widgetName=ips.getSetting('nbitunes_ckeditor_widget');var element=CKEDITOR.dom.element.createFromHtml(editor.widgets.registered[widgetName].template.source);element.appendHtml(templateRender);editor.insertElement(element);editor.widgets.initOn(element,widgetName);}}catch(err){}}
target.trigger('closeDialog');},paginationClicked:function(e,data){e.preventDefault();data.originalEvent.preventDefault();var scope=this.scope;var results=scope.find('[data-role="nbITunesResults"]');var url=data.href;if(url=='#'||e.type=='paginationJump'){url=data.paginationElem.find('[data-role="pageJump"]').attr('action')+'&page='+data.pageNo;}
this._disabled.push(scope);this._disableEnableElements(true);var self=this;this._ajax=ips.getAjax()(url,{showLoading:true,data:{params:this._params,'minimal':true,}}).done(function(response){self._disableEnableElements(false);results.html(response);$(document).trigger('contentChange',[results]);});},focusITunesSearch:function(){this._timer=setInterval(_.bind(this._checkValue,this),800);},blurITunesSearch:function(){clearInterval(this._timer);},setParams:function(e,data){this._term=this.scope.find('[data-role="nbITunesSearch"]').val();if(!this._term){return;}
var params={};var scope=this.scope;scope.find('[data-role^="nbITunesFilters_"] select').each(function(){params[$(this).attr("name")]=$(this).val();});if(params==this._params){return true;}
this._params=params;this._disabled.push(scope);this._disableEnableElements(true);this._loadResults();},_setupParams:function(e){var params={};var scope=this.scope;scope.find('[data-role^="nbITunesFilters_"] select').each(function(){params[$(this).attr("name")]=$(this).val();});this._params=params;},_disableEnableElements:function(disable){$.each(this._disabled,function(index,value){value.css({pointerEvents:(disable==true)?'none':'auto'}).animate({opacity:(disable==true)?0.5:1});});},_checkValue:function(e,data){var scope=this.scope;var term=scope.find('[data-role="nbITunesSearch"]').val();if(term==this._term){return;}
this._term=term;this._disabled.push(scope.find('[data-role="tablePagination"]'));this._disabled.push(scope.find('[data-role^="nbITunesFilters_"]'));this._disabled.push(scope.find('[data-role="nbITunesResults"]'));this._disableEnableElements(true);this._loadResults();},_loadResults:function(){var self=this;var scope=this.scope;var url=scope.attr('data-baseurl');if(this._ajax&&this._ajax.abort){this._ajax.abort();}
this._setupParams();scope.find('[data-role="nbITunesSearch"]').addClass('ipsField_loading');this._ajax=ips.getAjax()(url,{data:{term:this._term,params:this._params,minimal:true,}}).done(function(response){self._disableEnableElements(false);self.scope.find('[data-role="nbITunesResults"]').html(response);$(document).trigger('contentChange',[self.scope.find('[data-role="nbITunesResults"]')]);}).always(function(){self.scope.find('[data-role="nbITunesSearch"]').removeClass('ipsField_loading');});}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('plugins.bim.statusReplies',{_statusID:null,_statusMember:null,initialize:function(){this.on('menuItemSelected','.cStatusTools [data-ipsMenu]',this._menuItemSelected);this.on('reloadFeed',this.reloadFeed);this._statusID=this.scope.attr('data-statusID');this._statusMember=this.scope.attr('data-statusMember');},_menuItemSelected:function(e,data){e=data?data.originalEvent:e;e.preventDefault();$(e.target).removeAttr('data-confirm');var self=this;var rowID=$(e.target).closest('.ipsMenu').attr('id').split("_")[1];var url=$(e.target).attr('href');ips.getAjax()(url).done(function(response){var container=self.scope.find('li[data-commentid="'+rowID+'"]');if(url.indexOf('action=delete')>=0){container.remove();}
else if(url.indexOf('action=hide')>=0){container.addClass('ipsModerated');var newUrl=url.replace('action=hide','action=unhide');$(e.target).attr('href',newUrl).text(ips.getString('bimStatus_unhide'));}
else if(url.indexOf('action=unhide')>=0){container.removeClass('ipsModerated');container.find('.ipsComment_author .ipsBadge_warning').hide();var newUrl=url.replace('action=unhide','action=hide');$(e.target).attr('href',newUrl).text(ips.getString('bimStatus_hide'));}});return false;},});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('plugins.bim.statusUpdatesWidget',{widgetKey:null,menu:null,isInitEditor:false,initialize:function(){this.on('focus','[data-role="statusFormArea"] .ipsComposeArea_dummy',this.focusNewStatus);this.on('submit','[data-role="statusFormArea"] form',this.submitNewStatus);this.on('submit','[data-role="statusFeed"] form',this.submitEdit);this.on('paginationClicked paginationJump',this.paginationClicked);this.on('menuItemSelected','.statusTools [data-ipsMenu]',this._menuItemSelected);this.on('reloadFeed',this.reloadFeed);this.on('reloadStatus',this.reloadStatus);this.on('menuOpened','[data-role="feedMenu"]',this.feedMenu);this.on('truncateExpanded','.statusContent ',this.truncateExpanded);this.on('click','[data-action="readLess"]',this.readless);this.on('click','[data-action="cancelPost"]',this.cancelPost);this.widgetKey=this.scope.attr('data-widgetKey');var elPage=this.scope.find('.ipsPagination');if(elPage){if(!elPage.data('data-ipsPagination-pageParam')){elPage.attr('data-ipsPagination','');elPage.attr('data-ipsPagination-pages',this.scope.attr('data-page-pages'));elPage.attr('data-ipsPagination-perPage',this.scope.attr('data-page-perpage'));elPage.attr('data-ipsPagination-pageParam','bimsuPage');}}},feedMenu:function(e,data){var self=this;if(!self.menu){self.menu=data['menu'];self.menu.find('form').on('submit',{widgetKey:self.widgetKey},self.submitSetting);}},submitSetting:function(e){e.preventDefault();var self=$('[data-controller="plugins.bim.statusUpdatesWidget"][data-widgetKey="'+e.data.widgetKey+'"]');var form=$(e.target).animate({opacity:0.5},300);ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusFeed',{data:form.serialize()+'&checkConf=1&widgetKey='+e.data.widgetKey,bypassRedirect:true}).always(function(){$(self).trigger('reloadFeed');$(self).one('reloadedFeed',function(){form.animate({opacity:1},300);});});return false;},focusNewStatus:function(e){e.preventDefault();var self=this;if(self.isInitEditor){self.showEditor();return false;}
$(e.currentTarget).text(ips.getString('loading')+"...");ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=status&controller=ajaxcreate',{data:{widgetKey:self.widgetKey,}}).done(function(response){self.isInitEditor=true;self.scope.find('[data-role="statusEditor"]').show();self.scope.find('[data-role="statusEditor"]').html(response);self.scope.find('[data-role="statusDummy"]').hide().find('.ipsComposeArea_dummy').text(ips.getString('whatsOnYourMind'));if(self.scope.find('[data-role="statusEditor"] .cancelPost').length<=0){self.scope.find('[data-role="statusEditor"] .ipsToolList').append("<li><a href='#' data-action='cancelPost' class='ipsButton ipsButton_link'>"+ips.getString('cancel')+"</a></li>");}
$(document).trigger('contentChange',[self.scope.find('[data-role="statusEditor"]')]);});return false;},hideEditor:function(e){this.scope.find('[data-role="statusDummy"]').show();this.scope.find('[data-role="statusEditor"]').hide();this.scope.find('[data-role="statusFeedEmpty"]').hide();},showEditor:function(e){ips.ui.editor.getObj(this.scope.find('[data-role="statusFormArea"] [data-ipsEditor]')).reset();this.scope.find('[data-role="statusDummy"]').hide();this.scope.find('[data-role="statusEditor"]').show();this.scope.find('[data-role="statusFeedEmpty"]').show()},cancelPost:function(e){this.hideEditor();return false;},submitNewStatus:function(e){e.preventDefault();var self=this;var form=$(e.currentTarget);form.find('button[type="submit"]').prop('disabled',true).text(ips.getString('updatingStatus'));ips.getAjax()(form.attr('action'),{data:form.serialize(),type:'post',bypassRedirect:true}).done(function(response){self.hideEditor();var statusID=$(response.content).attr('data-statusID');self.trigger('reloadStatus',{statusID:statusID});}).always(function(){form.find('button[type="submit"]').prop('disabled',false).text(ips.getString('submitStatus'));});return false;},paginationClicked:function(e,data){if(ips.getSetting('bimStatus_disableAjax')){return false;}
var self=this;var results=this.scope.find('[data-role="statusFeed"]');var url=data.href;data.originalEvent.preventDefault();if(url=='#'){url=data.paginationElem.find('[data-role="pageJump"]').attr('action')+'&bimsuPage='+data.pageNo+"&csrfKey="+ips.getSetting('csrfKey');}
this._ajax=ips.getAjax()(url,{showLoading:true,}).done(function(response){$('html, body').animate({scrollTop:self.scope.offset().top},600);results.html(response);$(document).trigger('contentChange',[results]);});},_menuItemSelected:function(e,data){e=data?data.originalEvent:e;e.preventDefault();switch($(e.target).attr('data-action')){case'edit':this._edit(e);break;case'delete':this._delete(e);break;case'hide':case'unhide':case'lock':case'unlock':this._reloadStatuses(e);break;default:return;}},reloadFeed:function(e){var results=this.scope.find('[data-role="statusFeed"]');var page=this.scope.find('[data-role="statusFeed"] .ipsPagination_active a').attr('data-page');if(typeof page=='undefined'){page=1;}
var self=this;ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusFeed',{showLoading:true,data:{widgetKey:self.widgetKey,bimsuPage:page}}).done(function(response){results.html(response);$(document).trigger('contentChange',[results]);}).always(function(){self.scope.trigger('reloadedFeed');});},reloadStatus:function(e,data){var self=this;ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusFeed',{showLoading:true,data:{widgetKey:self.widgetKey,statusID:data.statusID,}}).done(function(response){if(data.wrapper==1){var contentArea=$('.bimStatus_'+data.statusID).find('[data-role="statusContent"]');contentArea.html($(response).find('[data-role="statusContent"]').first().html()).hide().fadeIn();contentArea.closest('.ipsDataItem_main').find('.ipsItemControls').fadeIn();}
else{self.scope.find('[data-role="statusFeed"]').prepend(response);}
$(document).trigger('contentChange',[$('.bimStatus_'+data.statusID)]);});},_edit:function(e){e.preventDefault();var url=$(e.target).attr('href');var statusID=$(e.target).attr('data-statusID');var contentArea=$('.bimStatus_'+statusID).find('[data-role="statusContent"]');$(contentArea).animate({opacity:0.333},300);var self=this;ips.getAjax()($(e.target).attr('href'),{showLoading:true}).done(function(response){contentArea.html(response).animate({opacity:1},300);$(document).trigger('contentChange',[contentArea]);contentArea.closest('.ipsDataItem_main').find('.ipsItemControls').hide();contentArea.find('button[type="submit"]').attr('type','do_edit');contentArea.find('form').attr('data-statusID',statusID);});return false;},submitEdit:function(e){e.stopPropagation();e.preventDefault();var self=this;var form=$(e.target);var submit=form.find('button[type="do_edit"]');var statusID=form.attr('data-statusID');var currentText=submit.text();submit.prop('disabled',true).text(ips.getString('saving'));ips.getAjax()($(form).attr('action'),{showLoading:true,data:form.serialize(),bypassRedirect:true,method:"POST"}).done(function(response){self.trigger('reloadStatus',{statusID:statusID,wrapper:1});}).always(function(){submit.prop('disabled',false).text(currentText);});},_delete:function(e){e.preventDefault();var self=this;ips.ui.alert.show({type:'confirm',message:ips.getString('bimStatus_deleteConfirm'),icon:'warn',callbacks:{ok:function(){self._reloadStatuses(e);}}});return false;},_reloadStatuses:function(e){e.preventDefault();var feed=this.scope.find('.bimStatusUpdatesWidget');ips.getAjax()($(e.target).attr('href')).done(function(response){feed.trigger('reloadFeed');});return false;},readless:function(e){var el=$(e.currentTarget).closest('.statusContent');el.removeClass('isTruncated').addClass('ipsTruncate');el.removeAttr('data-truncated');el.removeAttr('style');$(document).trigger('contentChange',[$(e.currentTarget).closest('.statusContained')]);return false;},truncateExpanded:function(e){$(e.target).addClass('isTruncated');}});}(jQuery,_));ips.templates.set('bimStatus.readLess'," <a class='bimStatus_readLess' data-action='readLess'><span>{{#lang}}bimStatus_read_less{{/lang}} &nbsp;<i class='fa fa-caret-up'></i></span></a>");;
;(function($,_,undefined){"use strict";ips.controller.mixin('bimHideContentLike','core.front.core.reaction',true,function(){this.after('clickReaction',function(e){this.updatePostContent(e);});this.after('unreact',function(e){this.updatePostContent(e);});this.updatePostContent=function(e){if($(e.currentTarget).closest('.bimTopicFeed').length>0){var unhideAct=$(e.currentTarget).closest('.ipsStreamItem_container').find('.bimUnhideAct').first().text();}
else{var unhideAct=ips.getSetting('unhideAction');}
if(unhideAct=="like"||unhideAct=="both"){var id=$(e.currentTarget).closest('.ipsComment_content').attr('data-commentid');setTimeout(function(){ips.getAjax()(ips.getSetting('baseURL')+"?app=core&module=system&controller=plugins&do=bimViewContent",{type:'post',dataType:'json',data:{id:id}}).done(function(response){if(response.type=='error'){ips.ui.alert.show({message:response.message});}
else if(response.type=='OK'){var cmtWrapper=$('#comment-'+id+'_wrap').find('[data-role="commentContent"]');cmtWrapper.html(response.content).hide().fadeIn();$(document).trigger('contentChange',[cmtWrapper]);cmtWrapper.trigger('refreshContent');ips.utils.lazyLoad.loadContent(cmtWrapper);if(ips.getSetting('bim_gal_height')){var gal=cmtWrapper.find('div[class=galleria]');bimgallery.initGallery(gal);}
$(document).trigger('updateHideContent');}});},1000);}}});ips.controller.mixin('bimHideContentEditor','core.front.core.commentFeed',true,function(){if(ips.getSetting('unhideAction')){var unhideAct=ips.getSetting('unhideAction');}
if(unhideAct=="reply"||unhideAct=="both"){this.before('quickReply',function(e){if($('#bimHiddenContentRequires_reply').length||$('#bimHiddenContentRequires_both').length){this.scope.find('[data-role="replyArea"] form').attr('data-noAjax','true');}});}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('plugins.bimGiphy',{_timer:null,_ajax:null,_value:'',_type:'gifs',initialize:function(){this.on('click','[data-action="playGif"]',this.playGif);this.on('click','[data-action="selectGif"]',this.insertGif);this.on('focus','[data-role="gifSearch"]',this.focusGifSearch);this.on('blur','[data-role="gifSearch"]',this.blurGifSearch);this.on('change','[data-role="gifType"]',this._checkValue);this.on('paginationClicked paginationJump',this.paginationClicked);},playGif:function(e){var container=$(e.currentTarget).prev();var bg=container.css('background-image');bg=bg.replace('url(','').replace(')','').replace(/\"/gi,"");var gif=container.attr('data-preview');if(bg!=gif){container.css('background-image','url('+gif+')');console.log("Playing GIF");}},insertGif:function(e){var element=$(e.currentTarget).attr('class');var id=$(e.currentTarget).attr('data-gifid');var gif=$(e.currentTarget).attr('data-original');var title=$(e.currentTarget).closest('.giphyIMG').attr('title');var original=$(e.currentTarget).attr('data-original');var preview_gif=$(e.currentTarget).attr('data-preview');var still=$(e.currentTarget).attr('data-still');var eID=$(this.scope).data('editorid');if(eID.toLowerCase().indexOf("chatbox_")==0&&eID.toLowerCase().indexOf("chatbox_content_ajax")<0){var evar=eID.split("_");var cbWrapper=evar[1]=='room'?$('.room_'+evar[2]):$('.convo_'+evar[2]);cbWrapper.find('textarea').val(gif).closest('form').submit();}
else if(eID=='chatbox'){var input=$('[data-controller="bim.chatbox.free"]').find('input');input.val(gif);input.closest('form').click();}
else if(eID=='giphyCMD'){var mediaBox=this.scope.closest('.chatboxMedia');mediaBox.empty().hide();var input=mediaBox.next().find('textarea').length>0?mediaBox.next().find('textarea'):mediaBox.next().find('.bimcb_chatInput');input.val(gif).submit();}
else
{var editor=CKEDITOR.instances[eID];if(ips.getSetting('bim_giphy_play')==1){editor.insertHtml('<img alt="'+title+'" class="ipsImage bimGiphyIMG" src="'+gif+'">');}
else
{var element=CKEDITOR.dom.element.createFromHtml('<div class="bimGiphyContainer" contenteditable="false"></div>');element.setHtml('<img alt="'+title+'" class="ipsImage bimGiphyIMG" src="'+still+'"><div class="giphyPlayBtn"></div>');element.isEditable=false;editor.insertElement(element);editor.widgets.initOn(element,'bimGiphyContainer');$(document).trigger('contentChange',[$(element.$)]);}}
var item={'id':id,'title':title,'images':{'original':{'url':original},'preview_gif':{'url':preview_gif},'original_still':{'url':still}}};var existing=ips.utils.db.get('bimgiphy_gif','recent');if(!existing||!_.isArray(existing)){var json=[item];ips.utils.db.set('bimgiphy_gif','recent',json);}
else
{for(var key in existing){var obj=existing[key];if(obj.id==item.id){this.trigger('closeDialog');return;}}
existing.unshift(item);if(existing.length>12){existing.splice((existing.length-12)*-1,existing.length-12);}
ips.utils.db.set('bimgiphy_gif','recent',existing);}
this.trigger('closeDialog');},paginationClicked:function(e,data){var self=this;var results=this.scope.find('[data-role="gifResults"]');var url=data.href;data.originalEvent.preventDefault();if(url=='#'){url=data.paginationElem.find('[data-role="pageJump"]').attr('action')+'&page='+data.pageNo;}
this._ajax=ips.getAjax()(url,{showLoading:true,data:{q:this._value,type:this._type,}}).done(function(response){results.html(response);$(document).trigger('contentChange',[results]);});},focusGifSearch:function(){this._timer=setInterval(_.bind(this._checkValue,this),700);},blurGifSearch:function(){clearInterval(this._timer);},_checkValue:function(){var value=this.scope.find('[data-role="gifSearch"]').val();var type=this.scope.find('[data-role="gifType"]').val();if(value==this._value&&type==this._type){return;}
this._value=value;this._type=type;this._loadResults();},_loadResults:function(){var self=this;var url=this.scope.attr('data-url');var recent=ips.utils.db.get('bimgiphy_gif','recent');var recentData=null;if(!this._value){if(_.isArray(recent)){recentData=JSON.stringify(recent);}}
if(this._ajax&&this._ajax.abort){this._ajax.abort();}
this.scope.find('[data-role="gifSearch"]').addClass('ipsField_loading');this._ajax=ips.getAjax()(url,{data:{q:this._value,type:this._type,offset:0,recent:recentData},type:'post',}).done(function(response){self.scope.find('[data-role="gifResults"]').html(response);$(document).trigger('contentChange',[self.scope.find('[data-role="gifResults"]')]);}).always(function(){self.scope.find('[data-role="gifSearch"]').removeClass('ipsField_loading');});}});}(jQuery,_));$(document).ready(function(){$(document).on('click touchend','.giphyPlayBtn',function(e){var container=$(this).closest('.bimGiphyContainer');var img=container.find('.bimGiphyIMG');var gifURL=img.attr('src').replace("giphy_s.gif","giphy.gif");if($(this).closest('.cke_inner').length<=0){img.attr('src',gifURL);$(this).hide();}
else
{var gifID="giphy_"+makeid();container.addClass(gifID);var div=$("<div />",{html:"<style>.cke_inner ."+gifID+" .giphyPlayBtn, .cke_inner ."+gifID+" .ipsImage { visibility: hidden; } .cke_inner ."+gifID+" { background-image: url('"+gifURL+"') }</style>"}).appendTo("body");}
return false;});function makeid(){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<5;i++)
text+=possible.charAt(Math.floor(Math.random()*possible.length));return text;}});;